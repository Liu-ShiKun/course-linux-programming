### 控制终端和转义序列

Linux通过一些字符转义和控制序列可以要求终端做更多的操作，而不仅仅是输出。

Linux控制台实现了VT102和ECMA-48/ISO  6429/ANSI  X3.64终端控制的子集，除此以外，Linux也有一些自己的控制序列。

转义序列的完整内容十分丰富，有些使用也很复杂，这里整理一些常用项进行示例说明。

先从一个简单的示例开始：

```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

int main(int argc, char *argv[]) {

    printf("\x1b[46m\x1b[30m");
    printf("Linux is great\n");
    printf("\x1b[0m");

	return 0;
}
```

这个程序会先把终端设置成黑色前景，孔雀蓝背景，输出‘Linux is great’，然后重置终端属性。‘\x1b’是ESC的16进制ASCII。

除一些特定的终端控制字符以外，所有的转义序列都要从ESC开始，在任何时候ESC都表示一个新的转义序列开始。你可以在终端中使用printf命令进行测试，'\e'字符作为ESC的转义。

移动光标到指定位置输出：

```c
printf "\e[5,20HI am a programmer\n"
```

#### 光标（游标）控制

| 序列                   | 说明                                        |
| ---------------------- | ------------------------------------------- |
| \<ESC>[{ROW};{COLUMN}H | 移动光标到指定位置，示例："\x1b[2;3H"       |
| \<ESC>[H               | 没有位置参数表示移动到左上角最开始的位置    |
| \<ESC>[{COUNT}A        | 光标上移COUNT行，默认是1行，示例："\x1b[2A" |
| \<ESC>[{COUNT}B        | 光标向下移动                                |
| \<ESC>[{COUNT}C        | 一行内，光标前移（右移）                    |
| \<ESC>[{COUNT}D        | 光标向后移动（左移）                        |

下面的示例程序使用了滚屏控制序列，注意'\033'是ESC的八进制表示，如果使用'\e'或是'\x1b'，由于D也是十六进制的字符，所以会连在一起导致转义错误。

```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

int main(int argc, char *argv[]) {
    printf("\e[r");
    
    for (int i=0; i<12; i++) {
        printf("\033D");
        fflush(stdout);
        usleep(200000);
        printf("--%d", i+1);
    }
    printf("done\n");
	return 0;
}
```

这个程序并没有使用换行，而是使用转义序列把光标向下移动一行。



#### 滚屏控制



| 转义序列              | 说明                           |
| --------------------- | ------------------------------ |
| \<ESC>[r              | 整个终端开启滚屏               |
| \<ESC>[{start};{end}r | 只在start行和end行之间开启滚屏 |
| \<ESC>D               | 向下滚动一行                   |
| \<ESC>M               | 向上滚动一行                   |

注意滚屏不会让光标回到列的最开始，而仅仅是在新的行继续输出，要让光标回到起点，需要移动光标的转义序列配合。



#### 擦除字符

| 转义序列  | 说明                               |
| --------- | ---------------------------------- |
| \<ESC>[K  | 擦除光标当前位置到行开始的所有字符 |
| \<ESC>[1K | 擦除光标当前位置到行尾的所有字符   |
| \<ESC>[2K | 擦除整行                           |
| \<ESC>[J  | 擦除当前行到终端最后的所有行       |
| \<ESC>[1J | 擦除当前行到开始的所有行           |
| \<ESC>[2J | 擦除整个终端                       |

配合光标移动的转义序列，可以实现清理屏幕的操作：

```c
printf "\e[2J\e[H"
```



#### 终端颜色输出

输出颜色使用\<ESC>[attr1;attr2....m的形式。 显示属性使用数字来表示：

| 基本属性 | 说明         |
| -------- | ------------ |
| 0        | 重置所有属性 |
| 1        | 亮色         |
| 2        | 暗色         |
| 4        | 下划线       |
| 5        | 闪烁         |
| 7        | 反色         |
| 8        | 隐藏         |



| 前景色 | 说明    |
| ------ | ------- |
| 30     | Black   |
| 31     | Red     |
| 32     | Green   |
| 33     | Yellow  |
| 34     | Blue    |
| 35     | Magenta |
| 36     | Cyan    |
| 37     | White   |



| 背景色 | 说明    |
| ------ | ------- |
| 40     | Black   |
| 41     | Red     |
| 42     | Green   |
| 43     | Yellow  |
| 44     | Blue    |
| 45     | Magenta |
| 46     | Cyan    |
| 47     | White   |

一些示例操作：

```c
//反色错误提示
printf "\e[7;31;47m Error:failed to update data\n \e[0m"

//闪烁错误提示
printf "\e[5;31;47m Error:failed to update data\n \e[0m"


//反色，下划线，闪烁错误提示
printf "\e[7;5;4;31;47m Error:failed to update data\n \e[0m"
```

注意在代码中使用一定要在不需要的时候重置属性，否则，后续的输出都会沿用新的设置。



