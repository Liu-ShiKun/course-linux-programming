## IO

IO就是输入和输出，操作的是文件，文件的类型可以是普通文件，也可以是其他类型的文件，如设备文件，sock文件等。在计算机领域的一些基础理论课程上，往往重视调度而轻视IO。然而计算机的IO操作是最复杂的操作之一，而调度大部分情况是可以不必关心的，操作系统会处理好。通常的大部分操作其核心都是针对IO的操作。

### 文件的基本操作





### IO重定向的实现原理

在shell中，重定向是经常要使用的功能。这里讨论的是IO重定向的原理并给出程序的实现。IO重定向的实现基于Linux的一个设计原则：

**最低可用文件描述符原则。**

简单来说，文件描述符是一个数组索引号，每个进程都记录了一组打开的文件，这组文件用一个数组来保存。数组的索引就是文件描述符。当一个进程在打开文件的时候，由于最低可用文件描述符原则，系统内核总会为此文件安排的描述符总是数组中最低可用的位置索引。

并且除此以外，还有一个依赖：文件描述符0，1，2作为标准输入，标准输出，标准错误输出和设备文件或者是其他类型的文件相关联。默认情况，0关联键盘对应的设备文件；1，2都是关联屏幕的设备文件。无论使用什么编程语言，当使用输出函数进行一些数据的输出时，就是输出到标准输出。当程序运行时，文件描述符0，1，2都是已经关联好的。

由于多数情况下就是在向关联的屏幕设备文件输出信息，所以这容易导致一个错误理解：输出函数就是直接向屏幕输出。

那程序如何控制重定向，以输出重定向为例。基于上文讨论的原则，当程序开始就使用close关闭描述符1。这个时候，最低可用文件描述符是1，此时open打开的文件，返回的描述符肯定是1。

```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/types.h>
#include <sys/stat.h>

int main(int argc, char *argv[])
{
    close(1); //此时描述符1和屏幕设备文件的关联已经断开

    int fd = -1;
    //成功打开文件后，fd的值是1
    fd = open("ioout",O_CREAT|O_APPEND|O_RDWR, S_IRUSR|S_IWUSR);
    if (fd<0) {
        perror("open");
        return -1;
    }

    /*
    	由于描述符1是作为标准输出，而此时关联到了一个普通文件，所以
    	标准输出函数最终的结果是输出到了ioout文件
    */
    printf("Linux is great %d\n", fd);

    return 0;
}
```

这个程序演示了如何实现输出重定向，还有一种实现方式，可以更好的控制实现重定向。使用dup2系统调用。dup2接收两个参数，这里并不给出函数的说明文档，这个函数的文档往往会误导读者。dup2接收两个参数都是表示文件描述符的整数，把第一个文件描述符的数据复制到第二个参数，而在此之前会检测后一个描述符是不是已经关联其他文件，是的话会先尝试关闭。这个函数可以精确控制要对哪个描述符进行重定向。

以下程序使使用dup2的重定向示例：

```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/types.h>
#include <sys/stat.h>

int main(int argc, char *argv[])
{
    int fd = -1;
    fd = open("ioout",O_CREAT|O_APPEND|O_RDWR, S_IRUSR|S_IWUSR);
    if (fd<0) {
        perror("open");
        return -1;
    }

    /*
    	fd指向新打开的文件，dup2会先执行close(1)，然后把fd的数据复制到文件描述符1
    	此时文件描述符1已经不再关联屏幕的设备文件，而是ioout文件，这时候文件描述符
    	fd和1都指向ioout文件，所以下一步可以执行close(fd)。
    */
    
    dup2(fd,1);
    close(fd);
    
    printf("IO redirect\n");

    return 0;
}
```



### 程序如何知道在执行时发生了输出重定向

回想ls命令，在输出到终端的时候，不同的文件会输出不同的颜色，当使用管道给less分页显示（ls | less），是没有颜色的。当使用管道时，实际上是发生了重定向，ls命令的标准输出重定向到了管道文件。

支持颜色输出是控制终端的行为，如果输出给less最后输出的是一些乱码的字符。那这种情况下，命令需要知道发生了重定向并关闭颜色输出模式。





### IO：阻塞和非阻塞





### *IO多路复用和异步IO



